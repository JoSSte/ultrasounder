<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pille Historik</title>
    <link rel="icon" type="image/png" href="/pellets.png" />
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>

<body>
    <script src="moment.min.js"></script>
    <script src="Chart.js"></script>
    <script src="chartjs-plugin-annotation.js"></script>
    <script src="jquery-3.3.1.js"></script>

    <div style="width:90%;margin: auto;">
        <canvas id="pilleChart"></canvas>
    </div>
    <select name="interval" id="interval">
        <option value="600">10 Minutter</option>
        <option value="900">15 Minutter</option>
        <option value="1800">Â½ Time</option>
        <option value="3600">1 Time</option>
        <option value="7200">2 Timer</option>
        <option value="10800">3 Timer</option>
    </select>
    <input type="button" value="Opdater kort" onclick="updateChartData()">

    <script>
    function selectItemByValue(elmnt, value){
      for(var i=0; i < elmnt.options.length; i++){
        if(elmnt.options[i].value === value) {
          elmnt.selectedIndex = i;
          break;
        }
      }
    }
    
    
    var data = [];
    var labels = [];
    var pilleChart;
    var interval = 3600;
    $("#interval").val(interval);
    var warningLevel = 14;
    window.chartColors = {
      red: 'rgb(255,  99, 132)',
      orange: 'rgb(255, 159,  64)',
      yellow: 'rgb(255, 205,  86)',
      green: 'rgb( 75, 192, 192)',
      blue: 'rgb( 54, 162, 235)',
      purple: 'rgb(153, 102, 255)',
      grey: 'rgb(231, 233, 237)',
      black: 'rgb(  0,   0,   0)',
      graphite: 'rgb( 50,  50,  50)'
    };

    function splitData(jsonData) {
      // Split timestamp and data into separate arrays
      labels = [],
      data = [];
      jsonData.forEach(function (packet) {
        labels.push(new Date(packet.Time));
        data.push(parseFloat(packet.Value));
      });
    }

    function updateChartData() {
      var intval = document.getElementById("interval").value;
      if (interval != intval) {
        console.log("Updating interval from " + interval + " to " + intval);
        interval = intval;
      }
      var jsonData = $.ajax({
          url: 'index.php?jsonaction=piller&interval=' + interval,
          dataType: 'json',
        }).done(function (newData) {
          splitData(newData);
          pilleChart.data.datasets[0].data = data;
          pilleChart.config.data.labels = labels;
          pilleChart.update();
        });

    }

    function drawLineChart() {

      var jsonData = $.ajax({
          url: 'index.php?jsonaction=piller&interval=' + interval,
          dataType: 'json',
        }).done(function (rawData) {
          splitData(rawData);

          // Create the chart.js data structure using 'labels' and 'data'
          var pilleData = {
            labels: labels,
            datasets: [{
                fillColor: "rgba(151,187,205,0.2)",
                strokeColor: window.chartColors.blue,
                borderColor: window.chartColors.graphite,
                borderWidth: 1,
                fill: false,
                label: 'Pilleniveau',
                data: data

              }
            ]
          };
          var options = {
            showLines: true,
            responsive: true,
            title: {
              display: true,
              text: 'Pilleniveau i beholder'
            },
            legend: {
              display: false
            },
            tooltips: {
              mode: 'index',
              intersect: true
            },
            annotation: {
              annotations: [{
                  type: 'line',
                  mode: 'horizontal',
                  scaleID: 'y-axis-0',
                  value: warningLevel,
                  borderColor: window.chartColors.red,
                  borderWidth: 1.5,
                  label: {
                    enabled: false,
                    content: 'Test label'
                  }
                }
              ]
            },
            scales: {
              yAxes: [{
                  ticks: {
                    beginAtZero: true
                  }
                }
              ],
              //Set X-Axis to date instead of labels
              xAxes: [{
                  type: 'time',
                  time: {
                    unit: 'day'
                  }
                }
              ]
            }
          }
          var ctx = document.getElementById("pilleChart").getContext("2d");
          // Instantiate a new chart
          pilleChart = new Chart(ctx, {
              type: 'line',
              data: pilleData,
              options: options
            });
        });
    }

    drawLineChart();
</script>
</body>

</html>
