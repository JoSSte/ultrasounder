<?php

// sensorpi.rawData to sensorread@localhost identified by '12345trewq'

// http://www.chartjs.org/docs/latest/
// http://microbuilder.io/blog/2016/01/10/plotting-json-data-with-chart-js.html
// https://codepen.io/jordanwillis/pen/qrXJLW

?>
<!doctype html>
<html>
<head>
    <title>Pille Historik</title>
    <link rel="icon" type="image/png" href="/pellets.png" />
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>

<body>
    <script src="moment.min.js"></script>
    <script src="Chart.js"></script>
    <script src="chartjs-plugin-annotation.js"></script>
    <script src="jquery-3.3.1.js"></script>

    <div style="width:90%;margin: auto;">
        <canvas id="pilleChart"></canvas>
    </div>

    <script>
        var lowestLevel = 16.5;
        window.chartColors = {
            red: 'rgb(255,  99, 132)',
            orange: 'rgb(255, 159,  64)',
            yellow: 'rgb(255, 205,  86)',
            green: 'rgb( 75, 192, 192)',
            blue: 'rgb( 54, 162, 235)',
            purple: 'rgb(153, 102, 255)',
            grey: 'rgb(231, 233, 237)',
            black: 'rgb(  0,   0,   0)',
            graphite: 'rgb( 50,  50,  50)'
        };

        function drawLineChart() {

            // Add a helper to format timestamp data
            Date.prototype.formatMMDDYYYY = function () {
                return (this.getMonth() + 1) +
                    "/" + this.getDate() +
                    "/" + this.getFullYear() +
                    " " + this.getHours() + ":00";
            }

            var jsonData = $.ajax({
                url: 'index.php?jsonaction=piller',
                dataType: 'json',
            }).done(function (results) {

                // Split timestamp and data into separate arrays
                var labels = [], data = [];
                results.forEach(function (packet) {
                    labels.push(new Date(packet.Time).formatMMDDYYYY());
                    data.push(parseFloat(packet.Value));
                });

                // Create the chart.js data structure using 'labels' and 'data'
                var pilleData = {
                    labels: labels,
                    datasets: [{
                        fillColor: "rgba(151,187,205,0.2)",
                        strokeColor: window.chartColors.blue,
                        /*pointColor: "rgba(151,187,205,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(151,187,205,1)",*/
                        borderColor: window.chartColors.graphite,
                        borderWidth: 1,
                        fill: false,
                        label: 'Pilleniveau',
                        data: data

                    }]
                };
                var options = {
                    showLines: true,
                    responsive: true,
                    title: {
                        display: true,
                        text: 'Pilleniveau i beholder'
                    },
                    legend: {
                        display: false
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: true
                    },
                    annotation: {
                        annotations: [{
                            type: 'line',
                            mode: 'horizontal',
                            scaleID: 'y-axis-0',
                            value: lowestLevel,
                            borderColor: window.chartColors.red,
                            borderWidth: 2,
                            label: {
                                enabled: false,
                                content: 'Test label'
                            }
                        }]
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }],
                        //Set X-Axis to date instead of labels
                        xAxes: [{
                            type: 'time',
                            time: {
                                unit: 'day'
                                }
                        }]
                    }
                };

                var ctx = document.getElementById("pilleChart").getContext("2d");
                // Instantiate a new chart
                var pilleChart = new Chart(ctx, {
                    type: 'line',
                    data: pilleData,
                    options: options
                });
            });
        }

        drawLineChart();

    </script>
</body>

</html>